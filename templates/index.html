<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Actionable E-commerce Sentiment Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #f5f7fa;
        color: #333;
    }

    /* Header */
    .header {
        background: linear-gradient(90deg,#83d0cb,#145277);
        color: white;
        padding: 25px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .header h1 {
        font-weight: 700;
        margin-bottom: 5px;
    }

    .header p {
        font-weight: 500;
        opacity: 0.9;
    }

    /* Sidebar */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 250px;
        background: linear-gradient(180deg,#1e1e2f,#2a2a3e);
        color: white;
        padding-top: 20px;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.15);
    }

    .sidebar h5 {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .sidebar-link {
        padding: 12px 20px;
        display: block;
        color: rgba(255,255,255,0.85);
        font-weight: 500;
        text-decoration: none;
        border-radius: 8px;
        margin: 5px 10px;
        transition: all 0.3s;
    }

    .sidebar-link:hover, .sidebar-link.active {
        background-color: #5656a0;
        color: #fff;
        transform: translateX(5px);
    }

    /* Main Content */
    .main-content {
        margin-left: 250px;
        padding: 20px 30px;
    }

    /* Card Styles */
    .card-sentiment {
        border-radius: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    }

    .card-sentiment:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .badge-positive {
        background-color: #28a745 !important;
        color: white !important;
    }
    .badge-negative {
        background-color: #dc3545 !important;
        color: white !important;
    }
    .badge-neutral {
        background-color: #6c757d !important;
        color: white !important;
    }
    .badge-anger {
        background-color: #ff5722 !important;
        color: white !important;
    }
    .badge-joy {
        background-color: #ffeb3b !important;
        color: #333 !important;
    }
    .badge-churn {
        background-color: #ffc107 !important;
        color: #333 !important;
    }
    .badge-inquiry {
        background-color: #17a2b8 !important;
        color: white !important;
    }
    .badge-sarcasm {
        background-color: #ff9800 !important;
        color: white !important;
    }

    .aspect-tag {
        margin-right: 5px;
        margin-top: 5px;
        font-size: 0.85em;
        font-weight: 500;
    }

    .rating-star {
        color: gold;
        margin-right: 2px;
    }

    /* Buttons */
    .btn-primary, .btn-secondary {
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    /* Review List */
    .list-group-item {
        border-radius: 10px;
        margin-bottom: 8px;
        border: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .list-group-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }

    /* Recommendation Card */
    #recommendationCard {
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s;
        text-align: center;
    }

    #recommendationCard h2 {
        font-weight: 700;
    }

    /* Setting initial states */
    #bulk-analysis-output {
        display: block; /* Hide Dashboard Results by default */
    }
    #manual-analysis-section {
        display: none; /* Show Manual Analysis by default */
    }
</style>
</head>
<body>



<div class="sidebar">
    <h5 class="text-center mb-4 text-warning">Sentiment Tool</h5>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="sidebar-link active" href="#" onclick="showSection('manual-analysis-section', this)">
                <i class="bi bi-pencil-square me-2"></i> Manual Analysis
            </a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" href="#" onclick="showSection('bulk-analysis-output', this)">
                <i class="bi bi-speedometer2 me-2"></i> Automated Analysis 
            </a>
        </li>
    </ul>
</div>

<div class="main-content">
    <header class="header text-center">
        <h1>ðŸš€ Detailed Sentiment Analysis Dashboard</h1>
        <p id="header-subtitle">Manually Analyze Text or Upload CSV</p>
    </header>

    <div class="container-fluid">
        
        <div id="manual-analysis-section" class="row mb-5 pt-4">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow p-3 rounded-4">
                    <div class="card-header bg-white rounded-top border-bottom-0">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="true" href="#single-review-tab" data-bs-toggle="tab">
                                    <i class="bi bi-chat-text me-1"></i> Single Text Analysis
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#csv-upload-tab" data-bs-toggle="tab">
                                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> CSV File Upload
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body tab-content">
                        <div class="tab-pane fade show active" id="single-review-tab">
                            <p class="text-muted">Enter a single review or comment for instant analysis:</p>
                            <textarea id="reviewInput" class="form-control mb-3 rounded-3" rows="3" 
                                placeholder="The screen resolution is superb, but the battery life is poor."></textarea>
                            <button class="btn btn-secondary w-100" onclick="analyzeSingleReview()">Analyze Single Review</button>
                            
                            <div id="singleReviewOutput" class="mt-4 p-3 border rounded-3" style="display: none;">
                                <h6>Detailed Analysis Result:</h6>
                                <p class="mb-1">Overall Sentiment: <span id="singleSentiment" class="badge"></span></p>
                                <p class="mb-1">Emotion Detected: <span id="singleEmotion" class="badge bg-info text-dark"></span></p>
                                <p class="mb-1">User Intent: <span id="singleIntent" class="badge bg-primary"></span></p>
                                <p class="mb-1">Aspects: <span id="singleAspects"></span></p>
                                <p class="mb-0">Advanced Flags: 
                                    <span id="singleSarcasm" class="badge bg-warning text-dark me-2"></span>
                                    <span id="singleLanguage" class="badge bg-secondary"></span>
                                </p>
                            </div>
                            </div>

                        <div class="tab-pane fade" id="csv-upload-tab">
                            <p class="text-muted">Upload a CSV file containing reviews for bulk analysis.</p>
                            <div class="alert alert-info small" role="alert">
                                <strong>Tip:</strong> Your CSV should have a column named **"review"** with the text you want to analyze.
                            </div>
                            <input type="file" id="csvFileInput" class="form-control mb-3" accept=".csv">
                            <button class="btn btn-primary w-100" onclick="processCSVFile()">Upload & Analyze Bulk CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="mb-5 border-4 border-primary">

        <div id="bulk-analysis-output">
            <div id="resultsContainer" class="row" style="display:none;">
                <div class="col-12 mb-4">
                    <h2 class="text-center text-primary">Automated Bulk Sentiment Output</h2>
                    <p class="text-center text-muted">Data loaded from web scrape</p>
                </div>

                <div class="col-12 mb-5">
                    <div id="recommendationCard" class="card shadow border-3 border-dark" style="display:none;">
                        <div class="card-body p-4">
                            <div class="row g-0 align-items-center">
                                <div class="col-md-3 d-flex justify-content-center">
                                    <img id="productImageDisplay" src="" alt="Product Image"
                                        style="max-width:100%; max-height:250px; border-radius:12px; display:none;">
                                </div>
                                <div class="col-md-9">
                                    <h4 class="card-title text-muted mb-3">Purchase Recommendation for:
                                        <strong id="productNameDisplay"></strong>
                                    </h4>
                                    <div id="recommendationContent"></div>
                                    <p class="mt-3 text-muted" id="recommendationMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 mb-5 text-center">
                    <button class="btn btn-lg btn-primary shadow-lg" onclick="generatePDFReport()">
                        <i class="bi bi-file-earmark-arrow-down-fill me-2"></i> Download Analysis Report
                    </button>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card card-sentiment h-100 border-success text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">Positive Reviews</h5>
                            <p class="card-text display-4" id="positiveCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card card-sentiment h-100 border-danger text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger">Negative Reviews</h5>
                            <p class="card-text display-4" id="negativeCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card card-sentiment h-100 border-secondary text-center">
                        <div class="card-body">
                            <h5 class="card-title text-secondary">Neutral Reviews</h5>
                            <p class="card-text display-4" id="neutralCount">0</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100 rounded-4">
                        <div class="card-header">Sentiment Distribution</div>
                        <div class="card-body"><canvas id="sentimentChart"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100 rounded-4">
                        <div class="card-header bg-warning-subtle">Aspect-Sentiment Matrix (Top 5)</div>
                        <div class="card-body p-2"><canvas id="aspectMatrixChart"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100 rounded-4">
                        <div class="card-header bg-primary-subtle">Sentiment Trend Over Time</div>
                        <div class="card-body"><canvas id="timeSeriesChart"></canvas></div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100 rounded-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Detailed Review Breakdown (<span id="totalReviews">0</span> Total)
                        </div>
                        <div class="card-body p-3">
                            <div class="d-flex mb-3 gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="filterReviews('All')">All</button>
                                <button class="btn btn-outline-success btn-sm" onclick="filterReviews('Positive')">Positive</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="filterReviews('Negative')">Negative</button>
                                <input type="text" id="keywordSearch" class="form-control form-control-sm ms-auto" onkeyup="filterReviews('All')" placeholder="Search keyword...">
                            </div>
                            <div class="review-list-wrapper" style="max-height: 400px; overflow-y:auto;">
                                <ul class="list-group list-group-flush" id="detailedResultsList"></ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> 

<script>
// --- Existing Global Variables ---
let sentimentChart, aspectMatrixChart, timeSeriesChart;
let allReviewData = []; 
let currentAnalysisData = {}; 

// --- Core Section Management Function ---
function showSection(sectionId, element) {
    // Hide all main sections
    document.getElementById('manual-analysis-section').style.display = 'none';
    document.getElementById('bulk-analysis-output').style.display = 'none';

    // Show the requested section
    document.getElementById(sectionId).style.display = 'block';

    // Update active state in sidebar
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
    });
    element.classList.add('active');
    
    // Update header subtitle for context
    if (sectionId === 'manual-analysis-section') {
        document.getElementById('header-subtitle').textContent = 'Manually Analyze Text or Upload CSV';
    } else if (sectionId === 'bulk-analysis-output') {
        document.getElementById('header-subtitle').textContent = 'Automated Analysis';
    }
}

// Ensure the correct section is visible on load (Manual Analysis)
// --- INITIALIZATION (Sets default visibility and handles session) ---
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');

    // 1. Get references to the sidebar links
    const manualLink = document.querySelector(".sidebar-link[onclick*='manual-analysis-section']");
    const bulkLink = document.querySelector(".sidebar-link[onclick*='bulk-analysis-output']");

    // Default state: Manual section visible, Bulk section hidden
    document.getElementById('manual-analysis-section').style.display = 'block';
    document.getElementById('bulk-analysis-output').style.display = 'none';
    
    // Ensure 'Manual Analysis' is active by default in the sidebar
    if (manualLink) {
        manualLink.classList.add('active');
    }
    if (bulkLink) {
        bulkLink.classList.remove('active');
    }

    if (sessionId) {
        document.title = "Analysis Results - Loading...";
        
        // When a sessionId is present, switch the view to 'Automated Analysis'
        if (bulkLink) {
            // Programmatically call showSection to set the correct state and active link
            showSection('bulk-analysis-output', bulkLink);
        }
        
        loadDataFromSession(sessionId);
    } else {
        // If no session ID, the manual section remains visible
        document.getElementById('resultsContainer').style.display = 'none';
        
        // Ensure 'Manual Analysis' is active
        if (manualLink) {
            manualLink.classList.add('active');
        }
    }
});


// ----------------------------------------
// --- MANUAL ANALYSIS (UPDATED FOR ADVANCED FEATURES) ----
// ----------------------------------------

/**
 * Placeholder for analyzing a single review text.
 * Mocks advanced NLP logic (Emotion, Intent, Sarcasm, Multilingual) based on keywords.
 */
function analyzeSingleReview() {
    const reviewText = document.getElementById('reviewInput').value.trim();
    const outputDiv = document.getElementById('singleReviewOutput');
    
    // Output spans for new fields
    const sentimentSpan = document.getElementById('singleSentiment');
    const emotionSpan = document.getElementById('singleEmotion');
    const intentSpan = document.getElementById('singleIntent');
    const aspectsSpan = document.getElementById('singleAspects');
    const sarcasmSpan = document.getElementById('singleSarcasm');
    const languageSpan = document.getElementById('singleLanguage');

    if (!reviewText) {
        alert("Please enter a review to analyze.");
        outputDiv.style.display = 'none';
        return;
    }

    const textLower = reviewText.toLowerCase();

    // --- MOCK ANALYSIS LOGIC ---
    let mockSentiment = 'Neutral';
    let mockEmotion = 'N/A';
    let mockIntent = 'N/A';
    let mockAspects = {};
    let mockSarcasm = false;
    let mockLanguage = 'English';

    // Sentiment and Emotion
    if (textLower.includes('superb') || textLower.includes('excellent') || textLower.includes('loved') || textLower.includes('mast hai')) {
        mockSentiment = 'Positive';
        mockEmotion = 'Joy';
    } else if (textLower.includes('poor') || textLower.includes('bad') || textLower.includes('broke') || textLower.includes('cancel')) {
        mockSentiment = 'Negative';
        mockEmotion = 'Anger';
    } else if (textLower.includes('que lastima')) {
        mockSentiment = 'Negative';
        mockEmotion = 'Sadness';
    } else {
        mockEmotion = 'Neutral';
    }

    // Intent Detection
    if (textLower.includes('upgrade') || textLower.includes('buy again') || textLower.includes('purchase')) {
        mockIntent = 'Purchase';
    } else if (textLower.includes('cancel') || textLower.includes('stop subscription') || textLower.includes('return')) {
        mockIntent = 'Churn';
    } else if (textLower.includes('how does') || textLower.includes('what size') || textLower.includes('where is')) {
        mockIntent = 'Inquiry';
    }
    
    // Aspect Detection
    if (textLower.includes('screen') || textLower.includes('resolution')) {
        mockAspects['Screen'] = textLower.includes('superb') ? 'Positive' : 'Neutral';
    }
    if (textLower.includes('battery') || textLower.includes('life')) {
        mockAspects['Battery'] = textLower.includes('poor') ? 'Negative' : 'Positive';
    }
    
    // Multilingual Detection
    if (textLower.includes('mast hai') || textLower.includes('badiya')) {
        mockLanguage = 'Hinglish';
    } else if (textLower.includes('que lastima') || textLower.includes('malo')) {
        mockLanguage = 'Spanish';
    }

    // Sarcasm Detection (Advanced)
    if (textLower.includes('amazing quality') && textLower.includes('broke')) {
        mockSarcasm = true;
        // In case of sarcasm, the true sentiment is the opposite of the surface words
        mockSentiment = 'Negative'; 
        mockEmotion = 'Anger';
    }
    // --- END MOCK LOGIC ---
    
    sentimentSpan.textContent = mockSentiment;
    sentimentSpan.className = 'badge ' + getSentimentClass(mockSentiment);
    
    emotionSpan.textContent = mockEmotion;
    emotionSpan.className = 'badge ' + getSentimentClass(mockEmotion.toLowerCase()); // Using emotion name for class
    
    intentSpan.textContent = mockIntent;
    intentSpan.className = 'badge bg-primary'; 
    
    aspectsSpan.innerHTML = formatAspects(mockAspects);
    
    sarcasmSpan.textContent = mockSarcasm ? 'âš ï¸ Sarcasm Detected' : 'No Sarcasm';
    sarcasmSpan.className = 'badge ' + (mockSarcasm ? 'badge-sarcasm' : 'bg-success');
    
    languageSpan.textContent = `Lang: ${mockLanguage}`;
    
    outputDiv.style.display = 'block';
    document.getElementById('reviewInput').value = ""; // Clear input after analysis
    
    alert(`Single Review Analyzed! Sentiment: ${mockSentiment}, Emotion: ${mockEmotion}`);
}

/**
 * Processes the uploaded CSV file.
 * Mocks bulk analysis results including new advanced features.
 */
function processCSVFile() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];

    if (!file) {
        alert("Please select a CSV file to upload.");
        return;
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            const csvData = results.data;
            
            if (!csvData[0] || !('review' in csvData[0])) {
                alert("Error: CSV file must contain a column named 'review'.");
                return;
            }

            // --- Mock Data Generation for Demo (Including New Fields) ---
            const newFields = {
                emotion: ['Joy', 'Anger', 'Sadness', 'Neutral'],
                intent: ['Purchase', 'Churn', 'Inquiry', 'Compliment'],
                is_sarcastic: [true, false, false, false, false, false, false, false, false, false], // 10% chance
                language: ['English', 'English', 'English', 'Hinglish', 'Spanish']
            };

            const mockBulkResults = csvData.map((row, index) => {
                // Ensure the review text is present
                const reviewText = row.review || 'No review text provided.';

                const sentiment = index % 3 === 0 ? 'Positive' : (index % 3 === 1 ? 'Negative' : 'Neutral');
                const aspects = sentiment === 'Positive' ? {'quality': 'Positive', 'delivery': 'Positive'} : {'size': 'Negative', 'price': 'Neutral'};
                
                // Advanced fields simulation
                const emotion = newFields.emotion[Math.floor(Math.random() * newFields.emotion.length)];
                const intent = newFields.intent[Math.floor(Math.random() * newFields.intent.length)];
                const is_sarcastic = newFields.is_sarcastic[Math.floor(Math.random() * newFields.is_sarcastic.length)];
                const language = newFields.language[Math.floor(Math.random() * newFields.language.length)];
                
                return {
                    review: reviewText.substring(0, 100) + (reviewText.length > 100 ? '...' : ''), // Truncate for display
                    sentiment: sentiment,
                    confidence: (0.7 + Math.random() * 0.3).toFixed(2),
                    rating: (Math.floor(Math.random() * 5) + 1),
                    date: `2024-05-${String(Math.floor(Math.random() * 30) + 1).padStart(2, '0')}`,
                    aspects: aspects,
                    emotion: emotion, // NEW
                    intent: intent,   // NEW
                    is_sarcastic: is_sarcastic, // NEW
                    language: language  // NEW
                };
            });
            
            const positiveCount = mockBulkResults.filter(r => r.sentiment === 'Positive').length;
            const negativeCount = mockBulkResults.filter(r => r.sentiment === 'Negative').length;
            const neutralCount = mockBulkResults.length - positiveCount - negativeCount;
            const total = mockBulkResults.length;

            const recommendationStatus = positiveCount > (negativeCount + neutralCount) ? 'Good' : (negativeCount > positiveCount ? 'Bad' : 'Decent');
            
            const mockAnalysisResult = {
                product_name: 'CSV Uploaded Reviews',
                product_image_url: '', 
                summary: {
                    Positive: positiveCount,
                    Negative: negativeCount,
                    Neutral: neutralCount,
                    total: total
                },
                recommendation: {
                    status: recommendationStatus,
                    message: `Analysis of ${total} reviews complete. Overall sentiment is ${recommendationStatus}. Key negative aspect: Size. Key positive aspect: Quality.`
                },
                drill_down_matrix: [
                    { aspect: 'Quality', Positive: 10, Negative: 2, Neutral: 1 },
                    { aspect: 'Price', Positive: 8, Negative: 5, Neutral: 3 },
                    { aspect: 'Delivery', Positive: 12, Negative: 1, Neutral: 0 },
                    { aspect: 'Size', Positive: 1, Negative: 15, Neutral: 4 } // A negative-driving aspect
                ],
                detailed_results: mockBulkResults
            };
            // --- End Mock Data Generation ---

            // Call the existing function to display the dashboard results
            processBulkData(mockAnalysisResult);
            showSection('bulk-analysis-output', document.querySelector('[onclick="showSection(\'bulk-analysis-output\', this)"]'));

            alert(`Successfully analyzed ${total} reviews from CSV! Displaying results in Dashboard.`);
        }
    });
}


// ----------------------------------------
// --- UTILITY AND DISPLAY FUNCTIONS (MODIFIED for New Fields) ---
// ----------------------------------------

function getSentimentClass(sentiment) {
    if (sentiment === 'Positive') return 'badge-positive';
    if (sentiment === 'Negative') return 'badge-negative';
    if (sentiment === 'Neutral') return 'badge-neutral';
    if (sentiment === 'joy') return 'badge-joy';
    if (sentiment === 'anger') return 'badge-anger';
    if (sentiment === 'sadness') return 'bg-info text-white';
    return 'badge-neutral';
}
function getStarRating(rating) {
    if (!rating) return '';
    const fullStar = '<i class="bi bi-star-fill rating-star"></i>';
    return fullStar.repeat(rating);
}
function formatAspects(aspects) {
    let html = '';
    for (const aspect in aspects) {
        const sentiment = aspects[aspect];
        const sentimentClass = getSentimentClass(sentiment);
        html += `<span class="badge rounded-pill aspect-tag ${sentimentClass}">${aspect}</span>`;
    }
    return html;
}

// --- Chart Display Functions (Kept as is) ---
function updateChart(summary) {
    const data = [summary.Positive, summary.Negative, summary.Neutral];
    const labels = ['Positive', 'Negative', 'Neutral'];
    const colors = ['#28a745', '#dc3545', '#6c757d'];

    if (sentimentChart) { sentimentChart.destroy(); }

    const ctx = document.getElementById('sentimentChart').getContext('2d');
    sentimentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                hoverOffset: 4
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: false } } }
    });
}

function updateAspectMatrixChart(matrixData) {
    const topAspects = matrixData.slice(0, 5);
    const labels = topAspects.map(item => item.aspect);
    
    const data = {
        labels: labels,
        datasets: [
            { label: 'Positive', data: topAspects.map(item => item.Positive), backgroundColor: '#28a745' },
            { label: 'Negative', data: topAspects.map(item => item.Negative), backgroundColor: '#dc3545' },
            { label: 'Neutral', data: topAspects.map(item => item.Neutral), backgroundColor: '#6c757d' }
        ]
    };

    if (aspectMatrixChart) { aspectMatrixChart.destroy(); }

    const ctx = document.getElementById('aspectMatrixChart').getContext('2d');
    aspectMatrixChart = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Review Count' } } }, plugins: { title: { display: false } } }
    });
}

function updateTimeSeriesChart(detailedResults) {
    const dailyData = detailedResults.reduce((acc, item) => {
        const date = item.date || new Date().toISOString().slice(0, 10);
        if (!acc[date]) { acc[date] = { total: 0, positive: 0, negative: 0 }; }
        acc[date].total += 1;
        if (item.sentiment === 'Positive') acc[date].positive += 1;
        if (item.sentiment === 'Negative') acc[date].negative += 1;
        return acc;
    }, {});

    const sortedDates = Object.keys(dailyData).sort();
    const positivePercentages = sortedDates.map(date => (dailyData[date].positive / dailyData[date].total) * 100);
    const negativePercentages = sortedDates.map(date => (dailyData[date].negative / dailyData[date].total) * 100);

    const data = {
        labels: sortedDates,
        datasets: [
            { label: 'Positive Trend (%)', data: positivePercentages, borderColor: '#28a745', tension: 0.1, fill: false },
            { label: 'Negative Trend (%)', data: negativePercentages, borderColor: '#dc3545', tension: 0.1, fill: false }
        ]
    };
    
    if (timeSeriesChart) { timeSeriesChart.destroy(); }
    
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: { responsive: true, scales: { y: { min: 0, max: 100, title: { display: true, text: 'Percentage (%)' } }, x: { title: { display: true, text: 'Date' } } }, plugins: { title: { display: false } } }
    });
}

// --- Recommendation & Image Display ---
function displayRecommendation(productName, recommendation, imageUrl) {
    const card = document.getElementById('recommendationCard');
    const content = document.getElementById('recommendationContent');
    const message = document.getElementById('recommendationMessage');
    const nameDisplay = document.getElementById('productNameDisplay');
    const imageDisplay = document.getElementById('productImageDisplay');
    
    card.style.display = 'block';
    nameDisplay.textContent = productName;
    message.textContent = recommendation.message;

    // Image Logic
    if (imageUrl) {
        imageDisplay.src = imageUrl;
        imageDisplay.style.display = 'block';
    } else {
        imageDisplay.style.display = 'none';
        imageDisplay.src = ''; 
    }

    let icon, title, bgClass;

    if (recommendation.status === 'Good') {
        icon = 'bi-check-circle-fill text-success';
        title = 'GO FOR IT!';
        bgClass = 'border-success';
    } else if (recommendation.status === 'Bad') {
        icon = 'bi-x-octagon-fill text-danger';
        title = 'PROCEED WITH CAUTION';
        bgClass = 'border-danger';
    } else { // Decent or Neutral
        icon = 'bi-info-circle-fill text-warning';
        title = 'MIXED REVIEWS';
        bgClass = 'border-warning';
    }

    content.innerHTML = `
        <i class="bi ${icon}" style="font-size: 3rem;"></i>
        <h2 class="card-text display-3 fw-bold">${title}</h2>
    `;
    
    card.className = `card shadow border-3 ${bgClass}`;
}

// --- UPDATED to display new fields (Emotion, Intent, Sarcasm, Language) ---
function populateDetailedList(data) {
    const list = document.getElementById('detailedResultsList');
    list.innerHTML = '';
    const keyword = document.getElementById('keywordSearch').value.toLowerCase();

    data.forEach(item => {
        // Filter logic
        if (keyword && !item.review.toLowerCase().includes(keyword)) {
            return; 
        }

        const sentimentClass = getSentimentClass(item.sentiment);
        const aspectHtml = formatAspects(item.aspects);
        const ratingStars = getStarRating(item.rating);
        
        // New advanced tags
        const emotionTag = item.emotion ? `<span class="badge ${getSentimentClass(item.emotion.toLowerCase())} text-uppercase me-1">${item.emotion}</span>` : '';
        const intentTag = item.intent ? `<span class="badge ${item.intent === 'Churn' ? 'badge-churn' : 'badge-inquiry'} text-uppercase me-1">${item.intent}</span>` : '';
        const sarcasmTag = item.is_sarcastic ? `<span class="badge badge-sarcasm text-uppercase me-1">SARCASTIC</span>` : '';
        const languageTag = item.language && item.language !== 'English' ? `<span class="badge bg-light text-dark me-1">${item.language}</span>` : '';

        const listItem = `
            <li class="list-group-item" data-sentiment="${item.sentiment}" data-rating="${item.rating || 0}">
                <div class="d-flex justify-content-between">
                    <span class="d-block mb-1 text-truncate"><strong>Review:</strong> ${item.review}</span>
                    <span class="badge bg-light text-dark">${ratingStars}</span>
                </div>
                <div class="d-flex align-items-center mb-1">
                    <span class="badge ${sentimentClass} rounded-pill me-2">
                        ${item.sentiment} (${item.confidence})
                    </span>
                    ${emotionTag}
                    ${intentTag}
                    ${sarcasmTag}
                    ${languageTag}
                </div>
                <div class="mt-1">${aspectHtml}</div>
            </li>
        `;
        list.innerHTML += listItem;
    });
}

function filterReviews(sentimentFilter = 'All') {
    let filteredData = allReviewData;
    
    if (sentimentFilter !== 'All') {
        filteredData = filteredData.filter(item => item.sentiment === sentimentFilter);
    }
    
    populateDetailedList(filteredData);
}

// --- Main Data Processing Functions (Hides Manual, Shows Bulk) ---
function processBulkData(data) {
    
    // Store all incoming data for PDF generation
    currentAnalysisData = data; 

    // This section is now managed by showSection() but is kept for data flow
    document.getElementById('manual-analysis-section').style.display = 'none'; 
    document.getElementById('bulk-analysis-output').style.display = 'block'; 
    document.getElementById('resultsContainer').style.display = 'flex'; 

    allReviewData = data.detailed_results;

    const summary = data.summary;
    document.getElementById('positiveCount').textContent = summary.Positive;
    document.getElementById('negativeCount').textContent = summary.Negative;
    document.getElementById('neutralCount').textContent = summary.Neutral;
    document.getElementById('totalReviews').textContent = summary.total;
    
    displayRecommendation(
        data.product_name || 'Analyzed Product', 
        data.recommendation,
        data.product_image_url || '' 
    ); 

    updateChart(summary);
    updateAspectMatrixChart(data.drill_down_matrix || []);
    updateTimeSeriesChart(data.detailed_results);
    populateDetailedList(allReviewData);
}

// --- Image Loading Helper for jsPDF ---
function getBase64Image(url) {
    return new Promise((resolve, reject) => {
        if (!url) return resolve(null);

        const img = new Image();
        img.crossOrigin = 'Anonymous'; // Essential for CORS issues
        img.onload = function () {
            const canvas = document.createElement('canvas');
            
            // Keep aspect ratio but limit size
            const maxWidth = 300;
            const ratio = this.naturalWidth / this.naturalHeight;
            canvas.width = Math.min(this.naturalWidth, maxWidth);
            canvas.height = canvas.width / ratio;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(this, 0, 0, canvas.width, canvas.height);
            
            resolve(canvas.toDataURL('image/jpeg', 0.9)); // Resolve with data URL
        };
        img.onerror = function (error) {
            console.error("Image loading failed:", error);
            // Fallback: If image fails to load, resolve with null
            resolve(null); 
        };
        img.src = url;
    });
}

// --- PDF Generation Function (COMPLETED) ---
async function generatePDFReport() {
    if (Object.keys(currentAnalysisData).length === 0) {
        alert("Please analyze a product first to generate a report.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    const padding = 15;
    const reviewLineHeight = 5;

    const data = currentAnalysisData;
    const productName = data.product_name || "Product Analysis Report";
    const productImageUrl = data.product_image_url || "";
    const summary = data.summary;
    const recommendation = data.recommendation;

    // Load Image
    let imageBase64 = null;
    if (productImageUrl) {
        imageBase64 = await getBase64Image(productImageUrl);
    }

    // --- Header Banner ---
    doc.setFillColor(0, 82, 163);
    doc.rect(0, 0, 210, 20, "F");
    doc.setFontSize(18);
    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold");
    doc.text("Sentiment Analysis Report", 105, 13, { align: "center" });
    y = 30;

    // --- Product Overview Box ---
    const boxHeight = 45;
    doc.setFillColor(245, 245, 245);
    doc.roundedRect(padding, y, 180, boxHeight, 3, 3, "F");
    doc.setDrawColor(200, 200, 200);
    doc.roundedRect(padding, y, 180, boxHeight, 3, 3);

    // Product Name (wrapped text)
    doc.setFont("helvetica", "bold");
    doc.setFontSize(13);
    doc.setTextColor(20, 20, 20);
    const productText = doc.splitTextToSize(`Product: ${productName}`, 120);
    doc.text(productText, padding + 5, y + 10);

    // Status
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.setTextColor(60, 60, 60);
    doc.text(`Status: ${recommendation.status}`, padding + 5, y + 25);

    // Executive Summary
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    const summaryText = doc.splitTextToSize(
        `Executive Summary: ${recommendation.message}`,
        120
    );
    doc.text(summaryText, padding + 5, y + 33);

    // Product Image (if available)
    if (imageBase64) {
        doc.addImage(imageBase64, "JPEG", 160, y + 5, 35, 30);
    }

    y += boxHeight + 20;

    // --- Sentiment Distribution Section ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(30, 30, 30);
    doc.text("Overall Sentiment Distribution", padding, y);
    y += 8;

    const cardWidth = 55;
    const cardHeight = 20;
    const gap = 8;
    const cardYOffset = 13;

    function drawCard(x, label, value, color) {
        doc.setFillColor(...color);
        doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.text(label, x + cardWidth / 2, y + 7, { align: "center" });
        doc.setFontSize(9);
        doc.text(value, x + cardWidth / 2, y + cardYOffset, { align: "center" });
    }

    drawCard(
        padding,
        "Positive",
        `${((summary.Positive / summary.total) * 100).toFixed(1)}% (${summary.Positive})`,
        [39, 174, 96]
    );
    drawCard(
        padding + cardWidth + gap,
        "Negative",
        `${((summary.Negative / summary.total) * 100).toFixed(1)}% (${summary.Negative})`,
        [192, 57, 43]
    );
    drawCard(
        padding + (cardWidth + gap) * 2,
        "Neutral",
        `${((summary.Neutral / summary.total) * 100).toFixed(1)}% (${summary.Neutral})`,
        [127, 140, 141]
    );

    y += cardHeight + 20;

    // --- Key Reviews Section ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(30, 30, 30);
    doc.text("Critical Review Insights", padding, y);
    y += 10;

    const positiveReviews = data.detailed_results
        .filter((r) => r.sentiment === "Positive")
        .slice(0, 1);
    const negativeReviews = data.detailed_results
        .filter((r) => r.sentiment === "Negative")
        .slice(0, 1);

    const keyReviews = [
        ...positiveReviews.map((r) => ({
            ...r,
            title: "Top Positive Insight",
            color: [39, 174, 96],
        })),
        ...negativeReviews.map((r) => ({
            ...r,
            title: "Key Negative Concern",
            color: [192, 57, 43],
        })),
    ];

    keyReviews.forEach((review, index) => {
        if (y > 250) {
            doc.addPage();
            y = 20;
        }

        // Title
        doc.setTextColor(...review.color);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text(review.title, padding, y);

        // User
        doc.setTextColor(100, 100, 100);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        const userName = review.user_name || "Anonymous";
        doc.text(`User: ${userName}`, 200 - padding, y, { align: "right" });
        y += 6;

        // Review Content
        doc.setTextColor(50, 50, 50);
        doc.setFontSize(10);
        const reviewText = `[Intent: ${review.intent || "N/A"}] ${review.review}`;
        const splitText = doc.splitTextToSize(reviewText, 180);
        doc.text(splitText, padding + 2, y);
        y += splitText.length * reviewLineHeight + 6;

        if (index < keyReviews.length - 1) {
            doc.setDrawColor(220, 220, 220);
            doc.line(padding, y - 2, 200, y - 2);
            y += 6;
        }
    });

    // --- Footer ---
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(
            `Generated by Sentiment Analyzer | Page ${i} of ${pageCount}`,
            105,
            290,
            { align: "center" }
        );
    }

    // --- Save PDF ---
    doc.save(`${productName.replace(/ /g, "_")}_Sentiment_Report.pdf`);
    alert("Report generated successfully. Downloading PDF...");
}

async function analyzeReviews(isBulkRequest) {
            // This function is placeholder for manual input
            alert("Single review analysis is currently not configured to display in a stable way via the bulk redirect endpoint. Please use the Chrome Extension on an e-commerce page.");
        }

        async function loadDataFromSession(sessionId) {
            const endpoint = `/api/get_session_data/${sessionId}`;
            
            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`Could not load session data. Status: ${response.status}`);
                }
                const data = await response.json();
                processBulkData(data);
            } catch (error) {
                console.error("Session load failed:", error);
                alert(`Error loading results: ${error.message}. Session may have expired.`); 
                document.getElementById('resultsContainer').style.display = 'none';
            }
        }

        // --- INITIALIZATION (Sets default visibility) ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            // Default state: Manual section visible, Bulk section hidden
            document.getElementById('manual-analysis-section').style.display = 'block';
            document.getElementById('bulk-analysis-output').style.display = 'none';

            if (sessionId) {
                document.title = "Analysis Results - Loading...";
                loadDataFromSession(sessionId);
            } else {
                // If no session ID, the manual section remains visible
                document.getElementById('resultsContainer').style.display = 'none';
            }
        });

</script>
</body>
</html>